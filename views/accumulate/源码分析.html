<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>源码分析 | Dust の blog</title>
    <meta name="description" content="种一棵树最好的时间是十年前，其次是现在">
    <link rel="icon" href="/Blog/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/Blog/assets/css/0.styles.8c347e2e.css" as="style"><link rel="preload" href="/Blog/assets/js/app.a66dfa13.js" as="script"><link rel="preload" href="/Blog/assets/js/5.3af05e9e.js" as="script"><link rel="preload" href="/Blog/assets/js/1.b259d1a7.js" as="script"><link rel="preload" href="/Blog/assets/js/16.3442ad82.js" as="script"><link rel="prefetch" href="/Blog/assets/js/10.439b12de.js"><link rel="prefetch" href="/Blog/assets/js/11.0d7f9ba6.js"><link rel="prefetch" href="/Blog/assets/js/12.eced248a.js"><link rel="prefetch" href="/Blog/assets/js/13.511028e6.js"><link rel="prefetch" href="/Blog/assets/js/14.0f25376e.js"><link rel="prefetch" href="/Blog/assets/js/15.38d852f8.js"><link rel="prefetch" href="/Blog/assets/js/17.c549cd6d.js"><link rel="prefetch" href="/Blog/assets/js/18.a77164f4.js"><link rel="prefetch" href="/Blog/assets/js/19.d8d9ba0d.js"><link rel="prefetch" href="/Blog/assets/js/20.777ce9fd.js"><link rel="prefetch" href="/Blog/assets/js/21.49fff4d7.js"><link rel="prefetch" href="/Blog/assets/js/22.28847594.js"><link rel="prefetch" href="/Blog/assets/js/23.47514db3.js"><link rel="prefetch" href="/Blog/assets/js/24.dc4ed03a.js"><link rel="prefetch" href="/Blog/assets/js/25.dc023c98.js"><link rel="prefetch" href="/Blog/assets/js/26.ff9cf69b.js"><link rel="prefetch" href="/Blog/assets/js/27.b2bf5d54.js"><link rel="prefetch" href="/Blog/assets/js/28.8622c17d.js"><link rel="prefetch" href="/Blog/assets/js/3.f3e7dc71.js"><link rel="prefetch" href="/Blog/assets/js/4.f59572fd.js"><link rel="prefetch" href="/Blog/assets/js/6.106d7d9e.js"><link rel="prefetch" href="/Blog/assets/js/7.eaed2d67.js"><link rel="prefetch" href="/Blog/assets/js/8.83fc2d2c.js"><link rel="prefetch" href="/Blog/assets/js/9.43617916.js">
    <link rel="stylesheet" href="/Blog/assets/css/0.styles.8c347e2e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Blog/" class="home-link router-link-active"><img src="/Blog/head.png" alt="Dust の blog" class="logo"> <span class="site-name">Dust の blog</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Blog/views/accumulate/JavaScript笔记.html" class="nav-link"><i class="iconfont reco-home"></i>
  积累
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/category/CSS.html" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  frontEnd
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/advance.html" class="nav-link"><i class="iconfont undefined"></i>
  advance
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/interview.html" class="nav-link"><i class="iconfont undefined"></i>
  interview
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/思考题.html" class="nav-link"><i class="iconfont undefined"></i>
  思考题
</a></li></ul></div></div><div class="nav-item"><a href="/Blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/Blog/views/interview/相互比较呀.html" class="nav-link"><i class="iconfont reco-other"></i>
  interview
</a></div><div class="nav-item"><a href="/Blog/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <a href="https://github.com/lichiaos/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Blog/views/accumulate/JavaScript笔记.html" class="nav-link"><i class="iconfont reco-home"></i>
  积累
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/category/CSS.html" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  frontEnd
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/advance.html" class="nav-link"><i class="iconfont undefined"></i>
  advance
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/interview.html" class="nav-link"><i class="iconfont undefined"></i>
  interview
</a></li><li class="dropdown-item"><!----> <a href="/Blog/category/思考题.html" class="nav-link"><i class="iconfont undefined"></i>
  思考题
</a></li></ul></div></div><div class="nav-item"><a href="/Blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/Blog/views/interview/相互比较呀.html" class="nav-link"><i class="iconfont reco-other"></i>
  interview
</a></div><div class="nav-item"><a href="/Blog/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <a href="https://github.com/lichiaos/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/views/accumulate/JavaScript笔记.html" class="sidebar-link">JavaScript笔记</a></li><li><a href="/Blog/views/accumulate/git常用命令.html" class="sidebar-link">git命令合集</a></li><li><a href="/Blog/views/accumulate/读书笔记.html" class="sidebar-link">ReadNotes</a></li><li><a href="/Blog/views/accumulate/CSS相关.html" class="sidebar-link">CSS相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/views/accumulate/JS-adv笔记.html" class="sidebar-link">JS-adv笔记</a></li><li><a href="/Blog/views/accumulate/源码分析.html" class="active sidebar-link">源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/views/accumulate/源码分析.html#jquery" class="sidebar-link">jQuery</a></li><li class="sidebar-sub-header"><a href="/Blog/views/accumulate/源码分析.html#zepto" class="sidebar-link">Zepto</a></li><li class="sidebar-sub-header"><a href="/Blog/views/accumulate/源码分析.html#vue" class="sidebar-link">Vue</a></li><li class="sidebar-sub-header"><a href="/Blog/views/accumulate/源码分析.html#react" class="sidebar-link">React</a></li><li class="sidebar-sub-header"><a href="/Blog/views/accumulate/源码分析.html#underscore" class="sidebar-link">underscore</a></li></ul></li><li><a href="/Blog/views/accumulate/算法结构.html" class="sidebar-link">算法结构</a></li><li><a href="/Blog/views/accumulate/设计模式.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>拓展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/views/accumulate/移动端.html" class="sidebar-link">移动端开发</a></li><li><a href="/Blog/views/accumulate/常用utils.html" class="sidebar-link">常用utils</a></li><li><a href="/Blog/views/accumulate/奇淫巧技.html" class="sidebar-link">奇淫巧技</a></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>源码分析</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>dustSmile</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>2019-9-4</span></i> <span id="/Blog/views/accumulate/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-2e99e05a data-v-0b496ca7><i class="iconfont reco-eye" style="margin-right: .5rem" data-v-2e99e05a></i> <a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;" data-v-2e99e05a></a></span> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      源码分析
    </span></i></div></div> <div class="content default"><h2 id="jquery"><a href="#jquery" aria-hidden="true" class="header-anchor">#</a> jQuery</h2> <h3 id="_1-或者-jquery-的调用"><a href="#_1-或者-jquery-的调用" aria-hidden="true" class="header-anchor">#</a> 1.$() 或者 jQuery()的调用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">jQuery</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>按照预期, 我们在调用这两个方法的时候肯定是<code>new</code>一个<code>jQuery</code>的实例, 但是我们在jQuery源码的内部并没有看到<code>return new jQuery()</code>的方法,
而是通过<code>return new jQuery.fn.init()</code>的方式, 看下面一段代码</p> <div class="language-js extra-class"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>fn <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>将<code>jQuery</code>的<code>prototype</code>的复制给<code>fn</code>的一个属性, 那么在<code>jQuery</code>原型上的<code>init</code>方法返回的是什么呢?</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> init <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
init<span class="token punctuation">.</span>prototype <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn
<span class="token comment">// 等价于</span>
jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>prototype <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>prototype
</code></pre></div><p>原来一开始<code>init()</code>的调用就是在相当于调用<code>jQuery()</code>, 设想如果一开始这样赋值</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">jQuery</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">jQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就会一直陷入死循环反复调用这个方法.所以采取了共享原型的设计.</p> <h3 id="_2-extend"><a href="#_2-extend" aria-hidden="true" class="header-anchor">#</a> 2.$.extend</h3> <div class="language-js extra-class"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>extend <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> target <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        len <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        options<span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
        deep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        copy<span class="token punctuation">,</span>
        copyArray<span class="token punctuation">,</span>
        clone<span class="token punctuation">,</span>
        src

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deep <span class="token operator">=</span> target
      target <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      i <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target <span class="token operator">=</span> <span class="token keyword">this</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> options <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        copy <span class="token operator">=</span> options<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        src <span class="token operator">=</span> target<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>jQuery<span class="token punctuation">.</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>copyArray <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>copyArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              clpyArray <span class="token operator">=</span> <span class="token boolean">false</span>
              clone <span class="token operator">=</span> src <span class="token operator">&amp;&amp;</span> jQuery<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">?</span> src <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              clone <span class="token operator">=</span> src <span class="token operator">&amp;&amp;</span> jQuery<span class="token punctuation">.</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">?</span> src <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>deep<span class="token punctuation">,</span> clone<span class="token punctuation">,</span> copy<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>copy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> copy
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-选择器"><a href="#_3-选择器" aria-hidden="true" class="header-anchor">#</a> 3. $() 选择器</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">init</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> match<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token number">0</span>
      context <span class="token operator">=</span> context <span class="token operator">||</span> document
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token comment">// 分两种情况, 查询or创建</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是创建: '&lt;div&gt; .&lt;a /&gt;'</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&lt;'</span> <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">[</span>selector<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&gt;'</span> <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          match <span class="token operator">=</span> <span class="token punctuation">[</span>selector<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          jQuery<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> jQuery<span class="token punctuation">.</span><span class="token function">parseHTML</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 查询</span>
          elem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
          <span class="token keyword">var</span> elems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span>
          <span class="token keyword">var</span> len <span class="token operator">=</span> elems<span class="token punctuation">.</span>length
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> elems<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> selector<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> selector
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    
    jQuery<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">merge</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> len <span class="token operator">=</span> <span class="token operator">+</span>second<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                  i <span class="token operator">=</span> first<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                  j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                first<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> second<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
              first<span class="token punctuation">.</span>length <span class="token operator">=</span> i
              <span class="token keyword">return</span> first
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">parseHTML</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">var</span> parse <span class="token operator">=</span> rejectExp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span>context<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>parse<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-callback"><a href="#_4-callback" aria-hidden="true" class="header-anchor">#</a> 4. callback</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">callbacks</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options <span class="token operator">=</span> <span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> optionsCache<span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">createOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">var</span> len<span class="token punctuation">,</span> i<span class="token punctuation">,</span> runFire<span class="token punctuation">,</span> memorey<span class="token punctuation">,</span> start<span class="token punctuation">,</span> starts

      <span class="token keyword">var</span> <span class="token function-variable function">fire</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> starts <span class="token operator">||</span> <span class="token number">0</span>
        len <span class="token operator">=</span> list<span class="token punctuation">.</span>length
        runFire <span class="token operator">=</span> <span class="token boolean">true</span>
        memorey <span class="token operator">=</span> options<span class="token punctuation">.</span>memory <span class="token operator">&amp;&amp;</span> data
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>stopOnfalse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">add</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          start <span class="token operator">=</span> list<span class="token punctuation">.</span>length
          <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
          args<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>memorey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            starts <span class="token operator">=</span> start
            <span class="token function">fire</span><span class="token punctuation">(</span>memorey<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 绑定上下文</span>
        <span class="token function-variable function">fireWith</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>once <span class="token operator">||</span> <span class="token operator">!</span>runFire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">[</span>context<span class="token punctuation">,</span> args<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 传递参数</span>
        <span class="token function-variable function">fire</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span><span class="token function">fireWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> self
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createOptions</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> optionsCache<span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    options<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">[</span>val<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> obj
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="zepto"><a href="#zepto" aria-hidden="true" class="header-anchor">#</a> Zepto</h2> <h3 id="core代码结构"><a href="#core代码结构" aria-hidden="true" class="header-anchor">#</a> Core代码结构</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Zepto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> $
  <span class="token comment">// ```省略N行代码</span>
  <span class="token function-variable function">$</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>seletor<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ```省略代码</span>
  <span class="token keyword">return</span> $
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>Zepto <span class="token operator">=</span> Zepto
window<span class="token punctuation">.</span>$ <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>$ <span class="token operator">=</span> Zepto<span class="token punctuation">)</span>
</code></pre></div><p><strong>zepto.init</strong>函数</p> <div class="language-js extra-class"><pre class="language-js"><code>zepto<span class="token punctuation">.</span>init <span class="token operator">=</span> <span class="token function">funtion</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dom
  <span class="token comment">// ``` 对dom变量进行一系列的处理</span>
  <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>zepto.Z</strong>函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 为每个获取到的对象添加方法</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">Z</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  dom <span class="token operator">=</span> dom <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  dom<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> $<span class="token punctuation">.</span>fn <span class="token comment">// 里面包含了zepto的一些api方法</span>
  dom<span class="token punctuation">.</span>selector <span class="token operator">=</span> selector <span class="token operator">||</span> <span class="token string">''</span>
  <span class="token keyword">return</span> dom
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* Zepto v1.1.6 - zepto event ajax form ie - zeptojs.com/license */</span>

<span class="token keyword">var</span> Zepto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> $<span class="token punctuation">,</span> classList<span class="token punctuation">,</span> 

      <span class="token comment">// 获取数组的slice 和 filter（返回数组中的满足回调函数中指定的条件的元素）方法</span>
      emptyArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> slice <span class="token operator">=</span> emptyArray<span class="token punctuation">.</span>slice<span class="token punctuation">,</span> filter <span class="token operator">=</span> emptyArray<span class="token punctuation">.</span>filter<span class="token punctuation">,</span>

      document <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">,</span>
      elementDisplay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> classCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      cssNumber <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'column-count'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token string">'columns'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token string">'font-weight'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token string">'line-height'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'opacity'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token string">'z-index'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token string">'zoom'</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 取出html代码中第一个html标签（或注释），如取出 &lt;p&gt;123&lt;/p&gt;&lt;h1&gt;345&lt;/h1&gt; 中的 &lt;p&gt;</span>
      fragmentRE <span class="token operator">=</span> <span class="token regex">/^\s*&lt;(\w+|!)[^&gt;]*&gt;/</span><span class="token punctuation">,</span>
      <span class="token comment">// 匹配 &lt;img /&gt; &lt;p&gt;&lt;/p&gt;  不匹配 &lt;img src=&quot;&quot;/&gt; &lt;p&gt;123&lt;/p&gt;</span>
      singleTagRE <span class="token operator">=</span> <span class="token regex">/^&lt;(\w+)\s*\/?&gt;(?:&lt;\/\1&gt;|)$/</span><span class="token punctuation">,</span>
      <span class="token comment">// 单标签</span>
      tagExpanderRE <span class="token operator">=</span> <span class="token regex">/&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^&gt;]*)\/&gt;/ig</span><span class="token punctuation">,</span>
      <span class="token comment">// body html</span>
      rootNodeRE <span class="token operator">=</span> <span class="token regex">/^(?:body|html)$/i</span><span class="token punctuation">,</span>
      <span class="token comment">// 大写字母</span>
      capitalRE <span class="token operator">=</span> <span class="token regex">/([A-Z])/g</span><span class="token punctuation">,</span>

      <span class="token comment">// special attributes that should be get/set via method calls</span>
      <span class="token comment">// 应该通过方法调用来设置/获取的特殊属性</span>
      methodAttributes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token string">'width'</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">,</span> <span class="token string">'offset'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

      adjacencyOperators <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'after'</span><span class="token punctuation">,</span> <span class="token string">'prepend'</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">,</span> <span class="token string">'append'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>

      table <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      tableRow <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定特殊元素的 容器</span>
      containers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'tr'</span><span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'tbody'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'tbody'</span><span class="token punctuation">:</span> table<span class="token punctuation">,</span> 
        <span class="token string">'thead'</span><span class="token punctuation">:</span> table<span class="token punctuation">,</span> 
        <span class="token string">'tfoot'</span><span class="token punctuation">:</span> table<span class="token punctuation">,</span>
        <span class="token string">'td'</span><span class="token punctuation">:</span> tableRow<span class="token punctuation">,</span> 
        <span class="token string">'th'</span><span class="token punctuation">:</span> tableRow<span class="token punctuation">,</span>
        <span class="token comment">// 除了上面指定的，其他所有元素的容器都是 div</span>
        <span class="token string">'*'</span><span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// interactive ？？？</span>
      readyRE <span class="token operator">=</span> <span class="token regex">/complete|loaded|interactive/</span><span class="token punctuation">,</span>

      <span class="token comment">// 匹配一个包括（字母、数组、下划线、-）的字符串</span>
      simpleSelectorRE <span class="token operator">=</span> <span class="token regex">/^[\w-]*$/</span><span class="token punctuation">,</span>

      class2type <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      toString <span class="token operator">=</span> class2type<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>

      zepto <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      camelize<span class="token punctuation">,</span> uniq<span class="token punctuation">,</span>

      tempParent <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token comment">// 属性转换为 camalCase 格式。</span>
      <span class="token comment">// $.fn.prop 方法用到了</span>
      propMap <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'tabindex'</span><span class="token punctuation">:</span> <span class="token string">'tabIndex'</span><span class="token punctuation">,</span>
        <span class="token string">'readonly'</span><span class="token punctuation">:</span> <span class="token string">'readOnly'</span><span class="token punctuation">,</span>
        <span class="token string">'for'</span><span class="token punctuation">:</span> <span class="token string">'htmlFor'</span><span class="token punctuation">,</span>
        <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'className'</span><span class="token punctuation">,</span>
        <span class="token string">'maxlength'</span><span class="token punctuation">:</span> <span class="token string">'maxLength'</span><span class="token punctuation">,</span>
        <span class="token string">'cellspacing'</span><span class="token punctuation">:</span> <span class="token string">'cellSpacing'</span><span class="token punctuation">,</span>
        <span class="token string">'cellpadding'</span><span class="token punctuation">:</span> <span class="token string">'cellPadding'</span><span class="token punctuation">,</span>
        <span class="token string">'rowspan'</span><span class="token punctuation">:</span> <span class="token string">'rowSpan'</span><span class="token punctuation">,</span>
        <span class="token string">'colspan'</span><span class="token punctuation">:</span> <span class="token string">'colSpan'</span><span class="token punctuation">,</span>
        <span class="token string">'usemap'</span><span class="token punctuation">:</span> <span class="token string">'useMap'</span><span class="token punctuation">,</span>
        <span class="token string">'frameborder'</span><span class="token punctuation">:</span> <span class="token string">'frameBorder'</span><span class="token punctuation">,</span>
        <span class="token string">'contenteditable'</span><span class="token punctuation">:</span> <span class="token string">'contentEditable'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 判断是否是arr的函数</span>
      isArray <span class="token operator">=</span> Array<span class="token punctuation">.</span>isArray <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> object <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token punctuation">}</span>

  <span class="token comment">// 上文定义 zepto = {}</span>
  <span class="token comment">// 判断 element 是否符合 selector 的选择要求</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">matches</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// selector有值，element有值，element是普通DOM节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector <span class="token operator">||</span> <span class="token operator">!</span>element <span class="token operator">||</span> element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment">// elem.matchesSelector('.item') </span>
    <span class="token comment">// 判断当前的 elem 是否符合传入的 selector 的要求 </span>
    <span class="token keyword">var</span> matchesSelector <span class="token operator">=</span> element<span class="token punctuation">.</span>webkitMatchesSelector <span class="token operator">||</span> 
                          element<span class="token punctuation">.</span>mozMatchesSelector <span class="token operator">||</span>
                          element<span class="token punctuation">.</span>oMatchesSelector <span class="token operator">||</span> 
                          element<span class="token punctuation">.</span>matchesSelector
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matchesSelector<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">matchesSelector</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>

    <span class="token comment">// 浏览器不支持 matchesSelector</span>
    <span class="token comment">// fall back to performing a selector:</span>
    <span class="token keyword">var</span> match<span class="token punctuation">,</span> 
        parent <span class="token operator">=</span> element<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> 
        temp <span class="token operator">=</span> <span class="token operator">!</span>parent

    <span class="token comment">// 上文定义 tempParent = document.createElement('div'),</span>
    <span class="token comment">// 如果没有parent，parent赋值为一个div，然后将当前元素加入到这个div中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parent <span class="token operator">=</span> tempParent<span class="token punctuation">;</span>
      tempParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// (parent = tempParent).appendChild(element); 这种写法不易读</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过 qsa 获取匹配的元素，判断其中有没有 element</span>
    match <span class="token operator">=</span> <span class="token operator">~</span>zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有parent时，之前执行过  tempParent.appendChild(element);</span>
      <span class="token comment">// 此时要移除子元素</span>
      tempParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// temp &amp;&amp; tempParent.removeChild(element)  // 这种写法不易读</span>

    <span class="token comment">// 返回最终的匹配结果，经过 qsa 判断的结果</span>
    <span class="token keyword">return</span> match
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> 
           <span class="token function">String</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span>  <span class="token comment">// null undefined</span>
           class2type<span class="token punctuation">[</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;object&quot;</span> 

    <span class="token comment">// 下文定义：</span>
    <span class="token comment">// // Populate the class2type map</span>
    <span class="token comment">// $.each(&quot;Boolean Number String Function Array Date RegExp Object Error&quot;.split(&quot; &quot;), function(i, name) {</span>
    <span class="token comment">//   class2type[ &quot;[object &quot; + name + &quot;]&quot; ] = name.toLowerCase()</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">type</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span>
  <span class="token comment">// window的特点：window.window === window</span>
  <span class="token keyword">function</span> <span class="token function">isWindow</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span> <span class="token keyword">return</span> obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">==</span> obj<span class="token punctuation">.</span>window <span class="token punctuation">}</span>
  <span class="token comment">// document.nodeType === 9</span>
  <span class="token comment">// elem.DOCUMENT_NODE 也等于 9 （这里直接判断是不是9也行？？？）</span>
  <span class="token keyword">function</span> <span class="token function">isDocument</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span> <span class="token keyword">return</span> obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>nodeType <span class="token operator">==</span> obj<span class="token punctuation">.</span><span class="token constant">DOCUMENT_NODE</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">type</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 判断是否是最基本的object：Object.getPrototypeOf(obj) == Object.prototype</span>
  <span class="token keyword">function</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isWindow</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype
  <span class="token punctuation">}</span>
  <span class="token comment">// 数组或者对象数组</span>
  <span class="token keyword">function</span> <span class="token function">likeArray</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token string">'number'</span> <span class="token punctuation">}</span>

  <span class="token comment">// 筛选数组，踢出 null undefined 元素</span>
  <span class="token keyword">function</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> item <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

  <span class="token comment">// 下文定义：</span>
  <span class="token comment">// $.fn = {</span>
  <span class="token comment">//    concat: emptyArray.concat,</span>
  <span class="token comment">// $.fn.concat.apply([], array) —— 无论 array 是不是数组，都将返回一个数组，</span>
  <span class="token comment">// 例如 $.fn.concat.call([], 'abc') 返回的是 ['abc']</span>
  <span class="token keyword">function</span> <span class="token function">flatten</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> array<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> $<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token punctuation">:</span> array <span class="token punctuation">}</span>

  <span class="token comment">// camelize 已在上文定义</span>
  <span class="token comment">// 用于 css 的 camalCase 转换，例如 background-color 转换为 backgroundColor</span>
  <span class="token function-variable function">camelize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/-+(.)?/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> chr</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> chr <span class="token operator">?</span> chr<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

  <span class="token comment">// 将 lineHeight 转换为 line-height 格式</span>
  <span class="token keyword">function</span> <span class="token function">dasherize</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/::/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([A-Z]+)([A-Z][a-z])/g</span><span class="token punctuation">,</span> <span class="token string">'$1_$2'</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([a-z\d])([A-Z])/g</span><span class="token punctuation">,</span> <span class="token string">'$1_$2'</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_/g</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// uniq变量已经在前面定义</span>
  <span class="token comment">// 用来将 [1,1,2,2,3,3] 替换为 [1,2,3]</span>
  <span class="token function-variable function">uniq</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">==</span> idx <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

  <span class="token comment">// 上文定义 classCache = {}</span>
  <span class="token keyword">function</span> <span class="token function">classRE</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name <span class="token keyword">in</span> classCache <span class="token operator">?</span>
           classCache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">:</span> 
           <span class="token punctuation">(</span>classCache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'(^|\\s)'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'(\\s|$)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// classCache 存储的数据是这样的：</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   abc: /(^|\s)abc(\s|$)/,  // 能匹配 'abc' 或 ' abc ' 或 ' abc' 或 'abc '</span>
    <span class="token comment">//   xyz: /(^|\s)abc(\s|$)/,</span>
    <span class="token comment">//   ...</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 传入一个 css 的 name 和 value，判断这个 value 是否需要增加 'px'</span>
  <span class="token keyword">function</span> <span class="token function">maybeAddPx</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// dasherize(name) 将 lineHeight 转换为 line-height 格式</span>
    <span class="token comment">// !cssNumber[dasherize(name)] 判断转换出来的 css name 是否再这个数组之外</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;number&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cssNumber<span class="token punctuation">[</span><span class="token function">dasherize</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
           <span class="token comment">// 如果 value 是数字，并且 name 不在 cssNumber 数组之内，就需要加 'px'，否则不需要</span>
           <span class="token comment">// 例如 'width'、'font-size' 就需要加 'px'， 'font-weight' 就不需要加</span>
           value <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span> <span class="token punctuation">:</span> 
           value

    <span class="token comment">// 前文定义----------------------</span>
    <span class="token comment">// cssNumber = {</span>
    <span class="token comment">//   'column-count': 1, </span>
    <span class="token comment">//   'columns': 1, </span>
    <span class="token comment">//   'font-weight': 1, </span>
    <span class="token comment">//   'line-height': 1,</span>
    <span class="token comment">//   'opacity': 1, </span>
    <span class="token comment">//   'z-index': 1, </span>
    <span class="token comment">//   'zoom': 1</span>
    <span class="token comment">// },</span>
    <span class="token comment">// function dasherize(str) {</span>
    <span class="token comment">//   return str.replace(/::/g, '/')</span>
    <span class="token comment">//             .replace(/([A-Z]+)([A-Z][a-z])/g, '$1_$2')</span>
    <span class="token comment">//             .replace(/([a-z\d])([A-Z])/g, '$1_$2')</span>
    <span class="token comment">//             .replace(/_/g, '-')</span>
    <span class="token comment">//             .toLowerCase()</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取一个元素的默认 display 样式值，可能的结果是：inline block inline-block table .... （none 转换为 block）</span>
  <span class="token comment">// $.fn.show 方法中用到了</span>
  <span class="token keyword">function</span> <span class="token function">defaultDisplay</span><span class="token punctuation">(</span><span class="token parameter">nodeName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> element<span class="token punctuation">,</span> display

    <span class="token comment">// 前文定义 elementDisplay = {}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elementDisplay<span class="token punctuation">[</span>nodeName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 如果 elementDisplay 对象中，没有存储 nodeName 的信息</span>
      <span class="token comment">// 则新建一个 nodeName 元素，添加到 body 中</span>
      element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
      <span class="token comment">// 获取它的默认的 display 样式信息。</span>
      display <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;display&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 接着马上移除元素！！！</span>
      element<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
      <span class="token comment">// 'none' 换成 'block'，另外还可能是 'inline' 'inline-block' 'table' 等等...</span>
      display <span class="token operator">==</span> <span class="token string">&quot;none&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>display <span class="token operator">=</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 存储下来</span>
      elementDisplay<span class="token punctuation">[</span>nodeName<span class="token punctuation">]</span> <span class="token operator">=</span> display

      <span class="token comment">// 下文定义 </span>
      <span class="token comment">// var nativeGetComputedStyle = getComputedStyle;</span>
      <span class="token comment">// window.getComputedStyle = function(element){</span>
      <span class="token comment">//   try {</span>
      <span class="token comment">//     return nativeGetComputedStyle(element)</span>
      <span class="token comment">//   } catch(e) {</span>
      <span class="token comment">//     return null</span>
      <span class="token comment">//   }</span>
      <span class="token comment">// }</span>
      <span class="token comment">// 解释：</span>
      <span class="token comment">// 如果浏览器支持 getComputedStyle 则使用，如果不支持，就返回 null</span>
      <span class="token comment">// getComputedStyle(elem, '伪类，如 :link') 返回一个 CSSStyleDeclaration 对象，里面存储了元素的样式信息，可以通过 getPropertyValue('name') 方法获取</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最终返回 display 结果</span>
    <span class="token keyword">return</span> elementDisplay<span class="token punctuation">[</span>nodeName<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回一个元素的子元素，数组形式</span>
  <span class="token keyword">function</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 有些浏览器支持 elem.children 获取子元素，有些不支持</span>
    <span class="token keyword">return</span> <span class="token string">'children'</span> <span class="token keyword">in</span> element <span class="token operator">?</span>

           <span class="token comment">// 上文定义 slice = [].slice</span>
           <span class="token comment">// slice.call(likeArr) 可以将对象数组转换为真正的数组</span>
           <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">:</span>

           <span class="token comment">// 浏览器不支持 elem.children 只能通过 elem.childNodes 获取子元素</span>
           <span class="token comment">// 只去 node.nodeType == 1 的子元素，通过 $.map 拼接成数组</span>
           <span class="token comment">// $.map 下文定义的， $.map = function (elements, callback) {....}</span>
           <span class="token comment">// $.map 作用：针对 elements（对象数组或数组），对每个元素都经过 callback 函数的过滤，并将过滤通过的元素，push到一个新数组中，返回新数组</span>
           $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>childNodes<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> node <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// 上文定义 zepto = {}</span>
  <span class="token comment">// 上文定义 zepto.matches = function(element, selector) { /* 判断elem是否符合selector的要求 */ }</span>

  <span class="token comment">// `$.zepto.fragment` takes a html string and an optional tag name</span>
  <span class="token comment">// to generate DOM nodes nodes from the given html string.</span>
  <span class="token comment">// The generated DOM nodes are returned as an array.</span>
  <span class="token comment">// This function can be overriden in plugins for example to make</span>
  <span class="token comment">// it compatible with browsers that don't support the DOM fully.</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">fragment</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> name<span class="token punctuation">,</span> properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
      参数：
      @html: 待处理的html字符串
      @name: 通过 name 可在 containers 中查找容器节点，如果不传入，取得的容器默认为 div
      @properties: 节点属性对象
    */</span>

    <span class="token keyword">var</span> dom<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> container

    <span class="token comment">// 上文定义：singleTagRE = /^&lt;(\w+)\s*\/?&gt;(?:&lt;\/\1&gt;|)$/,   // 匹配 &lt;img /&gt; &lt;p&gt;&lt;/p&gt;  不匹配 &lt;img src=&quot;&quot;/&gt; &lt;p&gt;123&lt;/p&gt;</span>
    <span class="token comment">// 如果 html 是单标签，则直接用该标签创建元素</span>
    <span class="token comment">// RegExp.$1 表示正则中的第一个括号匹配的内容，在此即 (\w+) 匹配的内容，</span>
    <span class="token comment">// A special case optimization for a single tag</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singleTagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> dom <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 说明 html 不是单标签，dom未被赋值</span>

      <span class="token comment">// 上文定义 tagExpanderRE = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^&gt;]*)\/&gt;/ig,   // 单标签</span>
      <span class="token comment">// 将 &lt;p/&gt;或&lt;p /&gt;，替换为 &lt;p&gt;&lt;/p&gt;，将&lt;p abc/&gt;替换为&lt;p&gt;abc&lt;/p&gt;</span>
      <span class="token comment">// &lt;input/&gt; （在 tagExpanderRE 中定义）的不替换</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>tagExpanderRE<span class="token punctuation">,</span> <span class="token string">&quot;&lt;$1&gt;&lt;/$2&gt;&quot;</span><span class="token punctuation">)</span>

      <span class="token comment">// fragmentRE = /^\s*&lt;(\w+|!)[^&gt;]*&gt;/,   // 取出html代码中第一个html标签（或注释），如取出 &lt;p&gt;123&lt;/p&gt;&lt;h1&gt;345&lt;/h1&gt; 中的 &lt;p&gt;</span>
      <span class="token comment">// 如果 name 未传入，则赋值为 html 的第一个标签</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> name <span class="token operator">=</span> fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span>

      <span class="token comment">// 上文定义</span>
      <span class="token comment">// // 指定特殊元素的 容器</span>
      <span class="token comment">// containers = {</span>
      <span class="token comment">//   'tr': document.createElement('tbody'),</span>
      <span class="token comment">//   'tbody': table, </span>
      <span class="token comment">//   'thead': table, </span>
      <span class="token comment">//   'tfoot': table,</span>
      <span class="token comment">//   'td': tableRow, </span>
      <span class="token comment">//   'th': tableRow,</span>
      <span class="token comment">//   // 除了上面指定的，其他所有元素的容器都是 div</span>
      <span class="token comment">//   '*': document.createElement('div')</span>
      <span class="token comment">// },</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> containers<span class="token punctuation">)</span><span class="token punctuation">)</span> name <span class="token operator">=</span> <span class="token string">'*'</span>

      container <span class="token operator">=</span> containers<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> html  <span class="token comment">// 转变为字符串的快捷方式</span>

      <span class="token comment">// 遍历 container 的子元素（先转换为数组形式）</span>
      <span class="token comment">// 返回的同时，将每个子元素移除。</span>
      <span class="token comment">// $.each 返回的是一个数组，因为第一个参数就是数组 slice.call(container.childNodes)</span>
      dom <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 赋值属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 先将dom转换为 zepto 对象</span>
      nodes <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>

      $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上文定义：</span>
        <span class="token comment">// // 应该通过方法调用来设置/获取的特殊属性</span>
        <span class="token comment">// methodAttributes = ['val', 'css', 'html', 'text', 'data', 'width', 'height', 'offset'],</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodAttributes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> nodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment">// 满足 methodAttributes 的，通过方法赋值</span>
        <span class="token keyword">else</span> nodes<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 否则，通过属性复制</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最终返回的dom可能有两种形式</span>
    <span class="token comment">// 第一，如果 html 是单标签，则dom被复制为一个zepto对象 dom = $(document.createElement(RegExp.$1))</span>
    <span class="token comment">// 第二，如果 html 不是单标签，则dom被复制为一个DOM节点的数组</span>
    <span class="token keyword">return</span> dom
  <span class="token punctuation">}</span>


  <span class="token comment">// 上文定义 zepto = {}</span>
  <span class="token comment">// 上文定义 zepto.matches = function(element, selector) { /* 判断elem是否符合selector的要求 */ }</span>
  <span class="token comment">// 上文定义 zepto.fragment = function(html, name, properties) { /* 通过html字符串获取文档碎片 */ }</span>

  <span class="token comment">// `$.zepto.Z` swaps out the prototype of the given `dom` array</span>
  <span class="token comment">// of nodes with `$.fn` and thus supplying all the Zepto functions</span>
  <span class="token comment">// to the array. Note that `__proto__` is not supported on Internet</span>
  <span class="token comment">// Explorer. This method can be overriden in plugins.</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">Z</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> dom <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 将 dom 隐式原型强制改为 $.fn</span>
    <span class="token comment">// 下文 zepto.Z.prototype = $.fn   因此，dom.__proto__ = $.fn 即 dom.__proto__ = zepto.Z.prototype  可以不较真的认为 zepto.Z 就是一个构造函数（但感觉这么设计，有些蹩脚）</span>
    dom<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> $<span class="token punctuation">.</span>fn
    dom<span class="token punctuation">.</span>selector <span class="token operator">=</span> selector <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">return</span> dom
  <span class="token punctuation">}</span>

  <span class="token comment">// `$.zepto.isZ` should return `true` if the given object is a Zepto</span>
  <span class="token comment">// collection. This method can be overriden in plugins.</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">isZ</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上文 dom.__proto__ = $.fn</span>
    <span class="token comment">// 下文 zepto.Z.prototype = $.fn</span>
    <span class="token comment">// 可知：dom.__proto__ === $.fn === zepto.Z.prototype</span>

    <span class="token comment">// 因此，zepto对象都符合 object instanceof zepto.Z</span>
    <span class="token keyword">return</span> object <span class="token keyword">instanceof</span> <span class="token class-name">zepto<span class="token punctuation">.</span>Z</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// `$.zepto.init` is Zepto's counterpart to jQuery's `$.fn.init` and</span>
  <span class="token comment">// takes a CSS selector and an optional context (and handles various</span>
  <span class="token comment">// special cases).</span>
  <span class="token comment">// This method can be overriden in plugins.</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> dom
    <span class="token comment">// If nothing given, return an empty Zepto collection</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Optimize for string selectors</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 字符串的情况，一般有两种：</span>
      <span class="token comment">// 第一，一段 html 代码，旨在通过zepto生成dom对象</span>
      <span class="token comment">// 第二，一段查询字符串，旨在通过zepto查找dom对象</span>
      <span class="token comment">// 将查询结果存储到 dom 变量中</span>

      selector <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// If it's a html fragment, create nodes from it</span>
      <span class="token comment">// Note: In both Chrome 21 and Firefox 15, DOM error 12</span>
      <span class="token comment">// is thrown if the fragment doesn't begin with &lt;</span>

      <span class="token comment">// 上文定义：</span>
      <span class="token comment">// // 取出html代码中第一个html标签（或注释），如取出 &lt;p&gt;123&lt;/p&gt;&lt;h1&gt;345&lt;/h1&gt; 中的 &lt;p&gt;</span>
      <span class="token comment">// fragmentRE = /^\s*&lt;(\w+|!)[^&gt;]*&gt;/,</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'&lt;'</span> <span class="token operator">&amp;&amp;</span> fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 第一，RegExp.$1取出来的就是第一个标签名称，即正则中 (\w+|!) 对应的内容</span>
        <span class="token comment">// 第二，此时的 context 应该传入的是css属性对象（这里会产生歧义，老版的不会传入 context）</span>
        dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> selector <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token comment">// If there's a context, create a collection on that context first, and select</span>
      <span class="token comment">// nodes from there</span>

      <span class="token comment">// 如果 selector 不是html字符串标签，并且 context 有值，则从context中查找</span>
      <span class="token comment">// find 应该是在 $.fn 中定义的，有待解读？？？</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
      <span class="token comment">// If it's a CSS selector, use it to select nodes.</span>

      <span class="token comment">// 除了以上情况，就从整个 document 执行 qsa 的查找</span>
      <span class="token keyword">else</span> dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If a function is given, call it when the DOM is ready</span>
    <span class="token comment">// 如果是函数，则dom ready时执行，</span>
    <span class="token comment">// ready方法应该在 $.fn 中定义，有待解毒</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>

    <span class="token comment">// If a Zepto collection is given, just return it</span>
    <span class="token comment">// 传入的参数本身就已经是 zepto 对象，则直接返回</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>zepto<span class="token punctuation">.</span><span class="token function">isZ</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> selector
    <span class="token keyword">else</span> <span class="token punctuation">{</span>

      <span class="token comment">// compact函数：踢出数组中 == null 的元素</span>
      <span class="token comment">// normalize array if an array of nodes is given</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> dom <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>

      <span class="token comment">// 如果传入的是object，直接强制塞进一个数组</span>
      <span class="token comment">// Wrap DOM nodes.</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> dom <span class="token operator">=</span> <span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">,</span> selector <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token comment">// 及时清空 selector 不妨碍下面的判断</span>


      <span class="token comment">// 从此往下，感觉和上文 selector 是字符串的情况下，重复了</span>
      <span class="token comment">// ？？？？？？？？</span>


      <span class="token comment">// fragmentRE.test 即判断字符串是否是 html 标签开头（即是否是html fragement）</span>
      <span class="token comment">// If it's a html fragment, create nodes from it</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//此时，context 也是属性集合，不是容器！！！</span>
        <span class="token comment">//（这里会产生歧义，老版的不会传入 context）</span>
        dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span> selector <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 及时清空 selector 不妨碍下面的判断</span>
      <span class="token comment">// If there's a context, create a collection on that context first, and select</span>
      <span class="token comment">// nodes from there</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
      <span class="token comment">// And last but no least, if it's a CSS selector, use it to select nodes.</span>
      <span class="token keyword">else</span> dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最终，还是通过 zepto.Z 创建了对象</span>
    <span class="token comment">// 这里的 dom，其实就是一个数组</span>
    <span class="token comment">// create a new Zepto collection from the nodes found</span>
    <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// `$` will be the base `Zepto` object. When calling this</span>
  <span class="token comment">// function just call `$.zepto.init, which makes the implementation</span>
  <span class="token comment">// details of selecting nodes and creating Zepto collections</span>
  <span class="token comment">// patchable in plugins.</span>
  <span class="token function-variable function">$</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// $ 最终被这个匿名函数所返回，并复制给了全局的 Zepto 变量</span>
  <span class="token comment">// 全局的 zepto 变量暴露给了 window，并且可能有一个别名—— $</span>
  <span class="token comment">// 此 $ 非彼 $ </span>
  <span class="token comment">// 对于初学者来说，这里肯定非常绕（还不如把这里的 $ 改改名字）</span>


  <span class="token keyword">function</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> source<span class="token punctuation">,</span> deep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 在上文已经定义，否则就污染全局变量了</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> source<span class="token punctuation">)</span>

      <span class="token comment">// 深度递归，首先必须 deep 参数为 true</span>
      <span class="token comment">// 其次，source[key] 必须是数组或者对象，才有必要深度递归（否则没必要）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// source[key] 是对象，而 target[key] 不是对象</span>
        <span class="token comment">// 则 target[key] = {} 初始化一下，否则递归会出错的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment">// source[key] 是数组，而 target[key] 不是数组</span>
        <span class="token comment">// 则 target[key] = [] 初始化一下，否则递归会出错的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment">// 执行递归</span>
        <span class="token function">extend</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> deep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 不满足以上条件，说明 source[key] 是一般的值类型，直接赋值给 target 就是了</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Copy all but undefined properties from one or more</span>
  <span class="token comment">// objects to the `target` object.</span>
  $<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 一般传入的参数会是：</span>
    <span class="token comment">// (targetObj, srcObj1, srcObj2, srcObj1...)</span>
    <span class="token comment">// (true, targetObj, srcObj1, srcObj2, srcObj1...)</span>

    <span class="token comment">// arguments 是对象数组，slice.call 会返回真正的数组（此处返回从第二项开始）</span>
    <span class="token keyword">var</span> deep<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">// 第一个参数是boolean，这里会把第二个参数当做 target，其他的作为 source</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">==</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deep <span class="token operator">=</span> target
      target <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将所有的 source 添加到 target 中</span>
    args<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">extend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> deep<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> target

    <span class="token comment">// 感觉这样设计是比较好，很好的将业务和底层进行了分离（虽然比较简单）：</span>
    <span class="token comment">// 核心方法再 function extend(...){...} 中定义，</span>
    <span class="token comment">// 而 $.extend 方法中做一些外围的判断和处理，最终调用 extend 函数去执行</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// `$.zepto.qsa` is Zepto's CSS selector implementation which</span>
  <span class="token comment">// uses `document.querySelectorAll` and optimizes for some special cases, like `#id`.</span>
  <span class="token comment">// This method can be overriden in plugins.</span>
  zepto<span class="token punctuation">.</span><span class="token function-variable function">qsa</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/*
      @element: 容器
      @selector: 选择器
    */</span>

    <span class="token keyword">var</span> found<span class="token punctuation">,</span>
        maybeID <span class="token operator">=</span> selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
        maybeClass <span class="token operator">=</span> <span class="token operator">!</span>maybeID <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">,</span>

        <span class="token comment">// ID或class形式：返回 selector.slice(1) 即ID或者class的值</span>
        <span class="token comment">// 否则：返回 selector，如通过 tagName 查询</span>
        nameOnly <span class="token operator">=</span> maybeID <span class="token operator">||</span> maybeClass <span class="token operator">?</span> selector<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> selector<span class="token punctuation">,</span> <span class="token comment">// Ensure that a 1 char tag name still gets checked</span>
        
        <span class="token comment">// 是否是一个简单的字符串（可能是一个复杂的选择器，如 'div#div1 .item[link] .red'）</span>
        isSimple <span class="token operator">=</span> simpleSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span>

    <span class="token comment">// 上文定义：</span>
    <span class="token comment">// // 匹配一个包括（字母、数组、下划线、-）的字符串</span>
    <span class="token comment">// simpleSelectorRE = /^[\w-]*$/,</span>



    <span class="token comment">// 以下代码的基本思路是：</span>
    <span class="token comment">// 1. 优先通过 ID 获取元素；</span>
    <span class="token comment">// 2. 然后试图通过 className 和 tagName 获取元素</span>
    <span class="token comment">// 3. 最后通过 querySelectorAll 来获取</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">isDocument</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isSimple <span class="token operator">&amp;&amp;</span> maybeID<span class="token punctuation">)</span> <span class="token operator">?</span>
           <span class="token comment">// 这是最简单的形式：容器是document、选择器是一个id</span>
           <span class="token comment">// 因为 getElementById 只能在 document 上用，所以这里单独拿出来</span>
           <span class="token punctuation">(</span> <span class="token punctuation">(</span>found <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
              <span class="token punctuation">[</span>found<span class="token punctuation">]</span> <span class="token punctuation">:</span> 
              <span class="token punctuation">[</span><span class="token punctuation">]</span> 
           <span class="token punctuation">)</span> <span class="token punctuation">:</span>

           <span class="token punctuation">(</span>element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
              <span class="token comment">// 容器不是一般元素，也不是document，直接返回 []</span>
              <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">:</span>

              <span class="token comment">// 将获取的所有元素集合，都转换为数组</span>
              <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                isSimple <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>maybeID 

                <span class="token comment">// isSimple情况下，nameOnly 只可能是 className 或者 tagName</span>
                <span class="token comment">// getElementsByClassName 和 getElementsByTagName 可以在 elem 上用，而且比 querySelectorAll 速度快</span>
                <span class="token comment">// 所以，只要elem容器有值，尽量单独拿出来处理</span>
                <span class="token operator">?</span> 
                  maybeClass <span class="token operator">?</span> 
                  element<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token comment">// If it's simple, it could be a class</span>
                  element<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>  <span class="token comment">// Or a tag</span>

                <span class="token comment">// 最后其他情况，只能通过 querySelectorAll 来处理</span>
                <span class="token punctuation">:</span> 
                element<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token comment">// Or it's not simple, and we need to query all</span>
              <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据 selector 筛选 nodes </span>
  <span class="token comment">// 并将 nodes 封装为 zepto 对象</span>
  <span class="token comment">// $.fn.filter 下文定义</span>
  <span class="token keyword">function</span> <span class="token function">filtered</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> selector <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">$</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 判断 parent 是否包含 node</span>
  $<span class="token punctuation">.</span>contains <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>contains <span class="token operator">?</span>
    <span class="token comment">// 浏览器支持 contains 方法</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> parent <span class="token operator">!==</span> node <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token punctuation">:</span>
    <span class="token comment">// 不支持 contains 方法</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>node <span class="token operator">=</span> node<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> parent<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 如果 arg 是函数，则改变函数的执行环境和参数</span>
  <span class="token comment">// 如果不是，直接返回 arg</span>
  <span class="token comment">// $.fn.html 方法就用到了</span>
  <span class="token keyword">function</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">arg</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">:</span> arg
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置属性</span>
  <span class="token keyword">function</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">:</span> node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置或获取 node 的 className</span>
  <span class="token comment">// 考虑 svg ？？？？</span>
  <span class="token comment">// access className property while respecting SVGAnimatedString</span>
  <span class="token keyword">function</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> klass <span class="token operator">=</span> node<span class="token punctuation">.</span>className <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
        svg   <span class="token operator">=</span> klass <span class="token operator">&amp;&amp;</span> klass<span class="token punctuation">.</span>baseVal <span class="token operator">!==</span> <span class="token keyword">undefined</span>

    <span class="token comment">// 获取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> svg <span class="token operator">?</span> klass<span class="token punctuation">.</span>baseVal <span class="token punctuation">:</span> klass
    <span class="token comment">// 设置</span>
    svg <span class="token operator">?</span> <span class="token punctuation">(</span>klass<span class="token punctuation">.</span>baseVal <span class="token operator">=</span> value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>className <span class="token operator">=</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将字符串变成响应的对象或者值，例如源代码的注释：</span>
  <span class="token comment">// &quot;true&quot;  =&gt; true</span>
  <span class="token comment">// &quot;false&quot; =&gt; false</span>
  <span class="token comment">// &quot;null&quot;  =&gt; null</span>
  <span class="token comment">// &quot;42&quot;    =&gt; 42</span>
  <span class="token comment">// &quot;42.5&quot;  =&gt; 42.5</span>
  <span class="token comment">// &quot;08&quot;    =&gt; &quot;08&quot;</span>
  <span class="token comment">// JSON    =&gt; parse if valid</span>
  <span class="token comment">// String  =&gt; self</span>
  <span class="token keyword">function</span> <span class="token function">deserializeValue</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value <span class="token operator">?</span>

        <span class="token comment">// value『有值』的情况：</span>
        value <span class="token operator">==</span> <span class="token string">&quot;true&quot;</span> <span class="token operator">||</span>  <span class="token comment">// 如果 value == 'true'，那么这个表达式本身就返回 true ，导致整个函数返回true</span>

          <span class="token comment">// value !== 'true' 的情况：</span>
          <span class="token punctuation">(</span> 
            value <span class="token operator">==</span> <span class="token string">&quot;false&quot;</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> <span class="token comment">// &quot;null&quot;  =&gt; null</span>
            value <span class="token operator">==</span> <span class="token string">&quot;null&quot;</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token comment">// &quot;null&quot;  =&gt; null</span>
            <span class="token operator">+</span>value <span class="token operator">+</span> <span class="token string">&quot;&quot;</span> <span class="token operator">==</span> value <span class="token operator">?</span> <span class="token operator">+</span>value <span class="token punctuation">:</span>  <span class="token comment">// 数字：&quot;42&quot; =&gt; 42  &quot;42.5&quot; =&gt; 42.5  （ 但是 '08' 却不符合这个条件 ）</span>
            <span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">[</span>\<span class="token punctuation">[</span>\<span class="token punctuation">{</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token comment">// '[...]' 或者 '{...}'</span>
            value <span class="token comment">// 其他</span>
          <span class="token punctuation">)</span>

        <span class="token comment">// value『无值』的情况： undefined / '' / flase / 0 / null</span>
        <span class="token punctuation">:</span> value 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将上文定义的函数，暴露给 $ 对象（其实 $ 是一个 function）</span>
  $<span class="token punctuation">.</span>type <span class="token operator">=</span> type
  $<span class="token punctuation">.</span>isFunction <span class="token operator">=</span> isFunction
  $<span class="token punctuation">.</span>isWindow <span class="token operator">=</span> isWindow
  $<span class="token punctuation">.</span>isArray <span class="token operator">=</span> isArray
  $<span class="token punctuation">.</span>isPlainObject <span class="token operator">=</span> isPlainObject

  $<span class="token punctuation">.</span><span class="token function-variable function">isEmptyObject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  $<span class="token punctuation">.</span><span class="token function-variable function">inArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> array<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> emptyArray<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  $<span class="token punctuation">.</span>camelCase <span class="token operator">=</span> camelize
  $<span class="token punctuation">.</span><span class="token function-variable function">trim</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// plugin compatibility</span>
  $<span class="token punctuation">.</span>uuid <span class="token operator">=</span> <span class="token number">0</span>
  $<span class="token punctuation">.</span>support <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  $<span class="token punctuation">.</span>expr <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token comment">// 重新组织 elements 对象（数组、对象或者对象数组），针对每一个元素，都用 callback 进行检验</span>
  <span class="token comment">// 检验通过后，将元素push进一个新数组，并返回</span>
  $<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elements<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> value<span class="token punctuation">,</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> key

    <span class="token comment">// 数组，或者对象数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likeArray</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历，经过 callback 验证，push到结果中</span>
        value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

    <span class="token comment">// 对象</span>
    <span class="token keyword">else</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历，经过 callback 验证，push到结果中</span>
        value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

    <span class="token comment">// 返回数组</span>
    <span class="token comment">// flatten 函数上文定义的，作用：无论 values 是否是数组，都将返回一个正确的数组。例如，传入 'abc' ，返回 ['abc']</span>
    <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 遍历 elements 所有元素（数组、对象数组、对象），执行 callback 方法，最终还是返回 elements</span>
  <span class="token comment">// 注意1：callback.call(elements[i], i, elements[i]) 函数执行的环境和参数</span>
  <span class="token comment">// 注意2：=== false) return elements 一旦有函数返回 false，即跳出循环，类似 break</span>
  <span class="token comment">// 注意3：无论哪种情况，最终返回的还是 elements</span>
  $<span class="token punctuation">.</span><span class="token function-variable function">each</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elements<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> i<span class="token punctuation">,</span> key
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likeArray</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> elements
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> elements<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> elements<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> elements
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> elements
  <span class="token punctuation">}</span>

  <span class="token comment">// 上文定义：filter = emptyArray.filter</span>
  <span class="token comment">// 筛选数组</span>
  $<span class="token punctuation">.</span><span class="token function-variable function">grep</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elements<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span> $<span class="token punctuation">.</span>parseJSON <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span>parse

  <span class="token comment">// Populate the class2type map</span>
  $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token string">&quot;Boolean Number String Function Array Date RegExp Object Error&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    class2type<span class="token punctuation">[</span> <span class="token string">&quot;[object &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span> <span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/*
      上文将 class2type 赋值为 {}
      最终将 class2type 赋值为：
      {
        '[object boolean]': 'boolean',
        '[object number]': 'number',
        '[object string]': 'string',
        ...
      }

      存储这个数据是为了方便的获取一些对象的类型，
      例如 Object.prototype.toString.call([]) 返回的是 '[Object Array]'
      那么即可根据这个获取 [] 的类型是 'array'
    */</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Define methods that will be available on all</span>
  <span class="token comment">// Zepto collections</span>
  $<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment">// 为何要这么多数组的方法？</span>
    <span class="token comment">// 因为一个 zepto 对象，本身就是一个数组</span>

    <span class="token comment">// Because a collection acts like an array</span>
    <span class="token comment">// copy over these useful array functions.</span>
    forEach<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>forEach<span class="token punctuation">,</span>
    reduce<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>reduce<span class="token punctuation">,</span>  <span class="token comment">// 方法何用？？？？</span>
    push<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>push<span class="token punctuation">,</span>
    sort<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>sort<span class="token punctuation">,</span>
    indexOf<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>indexOf<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> emptyArray<span class="token punctuation">.</span>concat<span class="token punctuation">,</span>

    <span class="token comment">// `map` and `slice` in the jQuery API work differently</span>
    <span class="token comment">// from their array counterparts</span>
    <span class="token function-variable function">map</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// $.map 上文定义的， $.map = function (elements, callback) {....}</span>
      <span class="token comment">// $.map 作用：针对 elements（对象、对象数组或数组），对每个元素都经过 callback 函数的过滤，并将过滤通过的元素，push到一个新数组中，返回新数组</span>

      <span class="token comment">// 最后，用 $ 封装返回</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>
        <span class="token comment">// $.map 返回的是一个数组</span>
        $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
          <span class="token comment">// 针对每一个元素，都执行传入的函数，如果函数返回的 !=null 就将插入到新返回的数组</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">,</span> el<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      <span class="token comment">/*
        $('div').map(function(key, value){
          return value.id;
          // 或者 return this.id;
        })
        这个结果就是 $(['div1', 'div2' ...])
      */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">slice</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 直接数组的slice方法，并将结果用 $ 封装返回</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 在 zepto.init 函数中，当传入的函数是函数时，就用到了 ready </span>
    <span class="token comment">// else if (isFunction(selector)) return $(document).ready(selector)</span>
    <span class="token function-variable function">ready</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// need to check if document.body exists for IE as that browser reports</span>
      <span class="token comment">// document ready when it hasn't yet created the body element</span>

      <span class="token comment">// 下文定义：readyRE = /complete|loaded|interactive/,</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readyRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token function">callback</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span>
      <span class="token keyword">else</span> document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">callback</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

      <span class="token comment">// 返回当前对象</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> idx <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> 
             <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token comment">// 未传参数，直接返回一整个数组</span>
             <span class="token comment">// 有参数，则试图返回单个元素（大于0，小于0 两种情况）</span>
             <span class="token keyword">this</span><span class="token punctuation">[</span>
                idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> 
                idx <span class="token punctuation">:</span> 
                idx <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length
            <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 将zepto集合变为纯数组</span>
    <span class="token function-variable function">toArray</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">size</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 将元素从这个DOM树中移除</span>
    <span class="token function-variable function">remove</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parentNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">each</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// [].every ES5中Array的新特性。循环数组每个元素，返回是否符合callback函数的要求</span>

      <span class="token comment">// every 函数返回的是 false 或者 true（不过这里返回什么无所谓，执行就可以了）</span>
      emptyArray<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> el<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 最后返回本身对象</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">filter</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// not函数下文定义</span>
      <span class="token comment">// 如果给not传入的参数是函数，则返回不符合这个函数规则的元素的数组（用 $ 封装）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">// 上文定义：zepto.matches 判断elements是否符合 selector 的要求</span>
      <span class="token comment">// zepto.matches = function(element, selector) {...}</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 利用 [].filter 方法做筛选，利用 zepto.matches 做判断</span>
        <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// $('div') 可能只有三个 div 节点，那么 $('div').add('p') 再三个 div 节点的基础上，增加三个 p 节点</span>
    <span class="token function-variable function">add</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span>context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// uniq函数——数组去重，例如：用来将 [1,1,2,2,3,3] 替换为 [1,2,3]</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token function">uniq</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">is</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 注意：这里只对 this[0] 第一个元素做判断了，其他的元素不管了</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> zepto<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">not</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> nodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存储最后返回的结果</span>

      <span class="token comment">// 如果参数是函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">.</span>call <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 遍历对象的所有元素，对每个元素都执行传入的函数</span>
          <span class="token comment">// 当函数返回 false 时（即不符合函数的规则），则将当前元素push到结果中，等待返回</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selector</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span> nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 如果参数不是函数</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 为 excludes 赋值</span>
        <span class="token keyword">var</span> excludes <span class="token operator">=</span> 
          <span class="token comment">// 如果 selector 是字符串（css选择器），则用filter过滤，将结果存储到 excludes 中</span>
          <span class="token keyword">typeof</span> selector <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">:</span>
          <span class="token comment">// 如果 selector 不是字符串</span>
          <span class="token comment">// 如果是数组或者对象数组（并且 selector.item 是函数？？？），则生成数组，赋值给 excludes</span>
          <span class="token punctuation">(</span><span class="token function">likeArray</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> 
          <span class="token comment">// 否则直接生成 zepto 对象，赋值给 excludes</span>
            <span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>

        <span class="token comment">// 至此，excludes 中就存储了通过 selector 查找出来的元素</span>

        <span class="token comment">// [].forEach 是ES5的新特性</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 取出 excludes 中不包含的元素，push到结果中</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>excludes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 返回最后的结果，用 $ 封装</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">has</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 经过 filter 函数处理，返回的是一个处理后的值</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">?</span>
          <span class="token comment">// 如果 seletor 是 object（可能是elem节点），则用 $.contains 判断</span>
          $<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span> <span class="token punctuation">:</span>
          <span class="token comment">// 否则（selector是css选择字符串）则返回find后的size（如果 size === 0 即相当于返回 false）</span>
          <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          <span class="token comment">// $.fn.find 在下文定义</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">eq</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 取出指定index的元素</span>
      <span class="token comment">// 可支持 -1、0、1、2 ……</span>
      <span class="token keyword">return</span> idx <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">first</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token comment">// 不是 object 则直接返回</span>
      <span class="token comment">// 是 object 类型，则用 $ 封装 （因为时刻都要支持链式操作！！！）</span>
      <span class="token keyword">return</span> el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el <span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">last</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">return</span> el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el <span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">find</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// result 存储返回结果</span>
      <span class="token keyword">var</span> result<span class="token punctuation">,</span> $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token keyword">this</span>

      <span class="token comment">// 如果没有参数，就返回一个空的 zepto 对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> result <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// 如果selector是对象</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token keyword">this</span>
          <span class="token keyword">return</span> emptyArray<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 如果 selector 不是对象（即是css选择器）：</span>

      <span class="token comment">// 如果只有一个元素，则使用 qsa 判断，结果经过 $ 封装后赋值给 result</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> result <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">// 如果有多个元素，则使用 map 遍历所有元素，使用 qsa 针对每个元素判断，符合条件即返回（map将返回包含符合条件的元素的新数组，并 $ 封装，支持链式操作！！）</span>
      <span class="token keyword">else</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      
      <span class="token comment">// 返回最终结果</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 从元素本身开始，逐级向上级元素匹配，并返回最先匹配selector的元素</span>
    <span class="token function-variable function">closest</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> collection <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token comment">// 如果 selector 是对象，则用 $ 封装后，赋值给 collection</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> collection <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>
        <span class="token comment">// while循环的判断条件：</span>
        <span class="token comment">// 第一，node有值（node一开始被赋值为对象的第一个元素）</span>
        <span class="token comment">// 第二，collection有值（传入的selector是对象）则collection包含node；collection无值（传入的selector是字符串，css选择），则node满足selector条件</span>
        <span class="token comment">// 满足第一个条件，不满足第二条件，则循环继续（node试图赋值为node.parentNode）；否则，循环跳出（说明已经找到了符合条件的父节点）</span>
        node <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
                    collection <span class="token operator">?</span> collection<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">:</span> zepto<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
        <span class="token comment">// node赋值成 node.parentNode</span>
        <span class="token comment">// 前提条件是：node != context &amp;&amp; node 不是 document，如果是这两个条件之一，那就不继续赋值</span>
        node <span class="token operator">=</span> node <span class="token operator">!==</span> context <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isDocument</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>parentNode
      
      <span class="token comment">// 返回最终结果</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取对象集合每个元素所有的祖先元素。 $('h1').parents() =&gt; [&lt;div#container&gt;, &lt;body&gt;, &lt;html&gt;]</span>
    <span class="token function-variable function">parents</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> ancestors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nodes <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 可能需要执行多次 while 循环</span>
        <span class="token comment">// 每次执行 $.map 函数都会对 nodes 重新赋值，然后再判断是否需要继续循环</span>
        <span class="token comment">// 因为要获取每个元素的所有祖先元素，所以要多次循环</span>
        nodes <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 使用 $.map（返回符合条件的元素的新数组，并用 $ 封装）遍历所有元素</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>node <span class="token operator">=</span> node<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isDocument</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ancestors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将符合条件的元素push到结果中</span>
            <span class="token comment">// 条件：不能是 document，结果中元素不能重复。否则不执行push</span>
            ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>

            <span class="token comment">// 返回的 node ，将拼接出新数组，重新复制给 nodes，然后试图继续执行 while 循环</span>
            <span class="token keyword">return</span> node
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 如果css选择器参数给出，过滤出符合条件的元素</span>
      <span class="token keyword">return</span> <span class="token function">filtered</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取对象集合中每个元素的直接父元素。如果css选择器参数给出。过滤出符合条件的元素。</span>
    <span class="token function-variable function">parent</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// pluck 函数在下文定义</span>
      <span class="token comment">// parent 函数，只获取第一级父节点即可</span>
      <span class="token keyword">return</span> <span class="token function">filtered</span><span class="token punctuation">(</span><span class="token function">uniq</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'parentNode'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获得每个匹配元素集合元素的直接子元素，可通过 selector 过滤</span>
    <span class="token function-variable function">children</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">filtered</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  selector
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获得每个匹配元素集合元素的子元素，包括文字和注释节点</span>
    <span class="token function-variable function">contents</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取对象集合中所有元素的兄弟节点，可通过 selector 过滤</span>
    <span class="token function-variable function">siblings</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">filtered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 获取兄弟节点</span>
        <span class="token keyword">return</span> <span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token function">children</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> child<span class="token operator">!==</span>el <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">empty</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// `pluck` is borrowed from Prototype.js</span>
    <span class="token function-variable function">pluck</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">property</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 获取自定义属性，返回值，拼接数组</span>
      <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> el<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">show</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 返回当前对象，保证可链式操作</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token comment">// 第一步，针对内联样式，将 none 改为空字符串，如 &lt;p id=&quot;p2&quot; style=&quot;display:none;&quot;&gt;p2&lt;/p&gt;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">==</span> <span class="token string">&quot;none&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span>

        <span class="token comment">// 第二步，针对css样式，如果是 none 则修改为默认的显示样式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;display&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token function">defaultDisplay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nodeName<span class="token punctuation">)</span>

        <span class="token comment">// show 方法是为了显示对象，而对象隐藏的方式有两种：内联样式 或 css样式</span>
        <span class="token comment">// this.style.display 只能获取内联样式的值（获取属性值）</span>
        <span class="token comment">// getComputedStyle(this, '').getPropertyValue(&quot;display&quot;) 可以获取内联、css样式的值（获取 renderTree 的值）</span>
        <span class="token comment">// 因此，这两步都要做判断，</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">replaceWith</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newContent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 先在前面插入，然后将当前对象移除</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>newContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">wrap</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">structure</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 是否是函数</span>
      <span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>func<span class="token punctuation">)</span>
        <span class="token keyword">var</span> dom   <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 何时用 clone ？</span>
            <span class="token comment">// 第一，dom.parentNode 说明 dom 在文档结构中，不 clone 就会被移动</span>
            <span class="token comment">// 第二，this.length &gt; 1 说明当前对象有多个元素，每个元素都要添加，所有要clone</span>
            clone <span class="token operator">=</span> dom<span class="token punctuation">.</span>parentNode <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 借用 wrapAll 方法来做包装</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapAll</span><span class="token punctuation">(</span>
          func <span class="token operator">?</span> <span class="token function">structure</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">:</span>
            clone <span class="token operator">?</span> dom<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> dom
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 在所有匹配元素外面包一个单独的结构</span>
    <span class="token function-variable function">wrapAll</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">structure</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先将 structure 插入到文档结构</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>structure <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">var</span> children
        <span class="token comment">// drill down to the inmost element</span>
        <span class="token comment">// 通过循环，将 structure 重新赋值为当前 structure 的最深处的一个子元素 </span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>children <span class="token operator">=</span> structure<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> structure <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 将所有子元素都包裹进 structure</span>
        <span class="token function">$</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 返回当前对象</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">wrapInner</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">structure</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 是否是函数</span>
      <span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span>

      <span class="token comment">// 返回对象自身，保证链式操作</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contents <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 是函数，即获取函数执行的返回结果；否则直接用 structure 参数</span>
            dom  <span class="token operator">=</span> func <span class="token operator">?</span> <span class="token function">structure</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">:</span> structure

        <span class="token comment">// 如果当前元素有内容，则通过内容 wrapAll。无内容，则直接用自身的 append 增加</span>
        contents<span class="token punctuation">.</span>length <span class="token operator">?</span> contents<span class="token punctuation">.</span><span class="token function">wrapAll</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span> <span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">unwrap</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 通过 this.parent() 获取每个元素的父节点（集合）</span>
      <span class="token comment">// 遍历这个父节点的集合</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 将当前父节点替换为它的子节点</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 返回对象自身，保证链式操作</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">clone</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 通过 this.map 循环对象，</span>
      <span class="token comment">// 针对每个元素都返回它的clone         这个 this 和前面的 this 不一样</span>
      <span class="token comment">// 返回新数组（用 $ 封装）</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hide</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">&quot;display&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 切换显示和隐藏</span>
    <span class="token function-variable function">toggle</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">setting</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">/*
        @setting
        true : 强制切换为 show
        false : 强制切换为 hide
      */</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

        <span class="token comment">// 条件判断：</span>
        <span class="token comment">// 如果 setting === undefined 则看 el.css(&quot;display&quot;) == &quot;none&quot;</span>
        <span class="token comment">// 如果 setting !== undefined 则看 !!setting</span>
        <span class="token punctuation">;</span><span class="token punctuation">(</span>setting <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> el<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">&quot;display&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;none&quot;</span> <span class="token punctuation">:</span> setting<span class="token punctuation">)</span> <span class="token operator">?</span> 
        el<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token comment">// 如果 true 则显示</span>
        el<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 如果 false 则隐藏</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 借助 previousElementSibling 属性</span>
    <span class="token function-variable function">prev</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'previousElementSibling'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>selector <span class="token operator">||</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 借助 nextElementSibling 属性</span>
    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'nextElementSibling'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>selector <span class="token operator">||</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">html</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> 

        <span class="token comment">// 情况1：有参数，赋值，并返回自身</span>
        <span class="token number">0</span> <span class="token keyword">in</span> arguments <span class="token operator">?</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">var</span> originHtml <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML
          <span class="token comment">// 传入的 html 参数允许是一个字符串，也允许是一个函数</span>
          <span class="token comment">// 通过 funcArg 函数：</span>
          <span class="token comment">//  1.如果 html 是字符串，则返回html</span>
          <span class="token comment">//  2.如果 html 是函数，则执行执行函数（传入 idx、originHtml），返回函数执行结果</span>
          <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> html<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> originHtml<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>

        <span class="token comment">/*
          插播：
          function funcArg(context, arg, idx, payload) {
            return isFunction(arg) ? arg.call(context, idx, payload) : arg
          }
        */</span>

        <span class="token comment">// 情况2：无参数，取值</span>
        <span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">in</span> <span class="token keyword">this</span> <span class="token operator">?</span> 
          <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerHTML <span class="token punctuation">:</span> <span class="token comment">// 直接取第一个元素的 innerHTML</span>
          <span class="token keyword">null</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">text</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> 

        <span class="token comment">// 情况1：有参数，赋值，并返回自身</span>
        <span class="token number">0</span> <span class="token keyword">in</span> arguments <span class="token operator">?</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// funcArg的应用，和html方法中一样</span>
          <span class="token keyword">var</span> newText <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> newText <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token operator">+</span>newText
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>

        <span class="token comment">// 情况2：无参数，取值</span>
        <span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">in</span> <span class="token keyword">this</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>textContent <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token comment">// 直接借用 textContent 属性</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">attr</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> result

      <span class="token keyword">return</span> 

        <span class="token comment">// 情况1：无第二个参数，读取值（读取值只能读取第一个元素的值）</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> name <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">in</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token punctuation">:</span>
          <span class="token comment">/*
            注释：
            this[0]是一个DOM节点，有『属性』也有『特性』
              result = this[0].getAttribute(name) 试图获取 DOM节点属性
              name in this[0] 判断是不是js对象的属性
            然后，该返回哪一个就返回哪一个
          */</span>
          <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> name <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
          <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">:</span> 
          result
        <span class="token punctuation">)</span> <span class="token punctuation">:</span>

        <span class="token comment">// 情况2：有第二个参数，设置值（针对每个元素设置值）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

          <span class="token comment">// 传入的参数可能是一个对象集合</span>
          <span class="token comment">// 此时，是不是应该放在『情况1』当中？？？此时，value根本没有用啊？？？</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> name<span class="token punctuation">)</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> name<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>

          <span class="token comment">// 传入的不是对象，即设置一个单一的属性。</span>
          <span class="token comment">// 但是，这里的 value 参数可以是一个函数</span>
          <span class="token comment">// funcArg 即处理了 value 是函数和非函数的两种情况</span>
          <span class="token keyword">else</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">removeAttr</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
            <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attribute</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> attribute<span class="token punctuation">)</span>  <span class="token comment">// 将属性设置为空，setAttribute会移除属性</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> 
            <span class="token keyword">this</span> <span class="token comment">// 改参数将成为 forEach 中函数的this</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 读取、设置属性（js对象的属性）</span>
    <span class="token function-variable function">prop</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// propMap 中存储的：key是html中的属性名称，value是js对象中的属性名称</span>
      <span class="token comment">// 例如，html中的 &quot;class&quot; 在DOM对象中，就需要使用 &quot;className&quot; 这个名字读取，同理于：for  maxlength  cellspacing 等等</span>
      name <span class="token operator">=</span> propMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> name

      <span class="token comment">/*
        上文定义：
        propMap = {
          'tabindex': 'tabIndex',
          'readonly': 'readOnly',
          'for': 'htmlFor',
          'class': 'className',
          'maxlength': 'maxLength',
          'cellspacing': 'cellSpacing',
          'cellpadding': 'cellPadding',
          'rowspan': 'rowSpan',
          'colspan': 'colSpan',
          'usemap': 'useMap',
          'frameborder': 'frameBorder',
          'contenteditable': 'contentEditable'
        }
      */</span>
      
      <span class="token keyword">return</span> 

        <span class="token comment">// 有第二个参数，设置属性</span>
        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">in</span> arguments<span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 设置属性值，funcArg处理函数或者非函数</span>
          <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>

        <span class="token comment">// 无第二个参数，读取属性（读取第一个元素的）</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 前面加上 'data-' 通过 attr 设置或者读取</span>
    <span class="token function-variable function">data</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">/*
        上文定义：
        capitalRE = /([A-Z])/g,  //大写字母
      */</span>

      <span class="token comment">//      前面加上 'data-'               将 'A' 替换为 '-a'</span>
      <span class="token keyword">var</span> attrName <span class="token operator">=</span> <span class="token string">'data-'</span> <span class="token operator">+</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>capitalRE<span class="token punctuation">,</span> <span class="token string">'-$1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">in</span> arguments<span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>attrName<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span>

      <span class="token keyword">return</span> data <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">deserializeValue</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">undefined</span>

      <span class="token comment">/*
        上文定义的，deserializeValue 函数的作用是：

        // 将字符串变成响应的对象或者值，例如源代码的注释：
        // &quot;true&quot;  =&gt; true
        // &quot;false&quot; =&gt; false
        // &quot;null&quot;  =&gt; null
        // &quot;42&quot;    =&gt; 42
        // &quot;42.5&quot;  =&gt; 42.5
        // &quot;08&quot;    =&gt; &quot;08&quot;
        // JSON    =&gt; parse if valid
        // String  =&gt; self
      */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">val</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> 

        <span class="token comment">// 有参数，设置值</span>
        <span class="token number">0</span> <span class="token keyword">in</span> arguments <span class="token operator">?</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 遍历每个元素，直接对 value 属性赋值</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>

        <span class="token comment">// 无参数，读取值</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
           <span class="token comment">// 如果元素是 &lt;select multiple&gt; 多选列表</span>
           <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>multiple <span class="token operator">?</span>
           <span class="token comment">// 返回所有选中的option的值的数组</span>
           <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'option'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>

                   <span class="token comment">/*
                      上文定义：
                      pluck: function(property){
                        return $.map(this, function(el){ return el[property] })
                      },
                   */</span>

           <span class="token comment">// 如果不是，直接获取 value</span>
           <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取、设置元素的 offset</span>
    <span class="token function-variable function">offset</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">coordinates</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 如果有 coordinates 参数，设置坐标值，并返回当前对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 支持函数（传入 $this.offset() 做参数）和非函数</span>
            coords <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">,</span> index<span class="token punctuation">,</span> $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 找到最近的 “relative”, “absolute” or “fixed” 的祖先元素，并获取它的 offset()</span>
            parentOffset <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">offsetParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// left 和 top 需要去掉定位的祖先元素的 left、top 值</span>
            props <span class="token operator">=</span> <span class="token punctuation">{</span>
              top<span class="token punctuation">:</span>  coords<span class="token punctuation">.</span>top  <span class="token operator">-</span> parentOffset<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
              left<span class="token punctuation">:</span> coords<span class="token punctuation">.</span>left <span class="token operator">-</span> parentOffset<span class="token punctuation">.</span>left
            <span class="token punctuation">}</span>

        <span class="token comment">// static时，设置 top、left是无效的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'position'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'static'</span><span class="token punctuation">)</span> props<span class="token punctuation">[</span><span class="token string">'position'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'relative'</span>

        <span class="token comment">// 通过 css 赋值</span>
        $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 当前对象是空，则返回 null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

      <span class="token comment">// 如果没有 coordinates 参数，则返回第一个元素的坐标值</span>
      <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">/*
        elem.getBoundingClientRect() 返回一个对象，
        包含元素的 top bottom left right width height 的值
        但是这个 top、bottom、left、right 是相对于浏览器窗口的距离，而不是页面的边界
        （注意，elem.getBoundingClientRect()在IE低版本浏览器有2px的兼容问题）

        window.pageXOffset 和 window.pageYOffset 可获取网页滚动的距离，
        IE低版本需要用 document.body.scrollLeft 和 document.body.scrollTop 兼容
      */</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        left<span class="token punctuation">:</span> obj<span class="token punctuation">.</span>left <span class="token operator">+</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>
        top<span class="token punctuation">:</span> obj<span class="token punctuation">.</span>top <span class="token operator">+</span> window<span class="token punctuation">.</span>pageYOffset<span class="token punctuation">,</span>
        width<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 设置、获取 css</span>
    <span class="token function-variable function">css</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">property<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

      <span class="token comment">// 只有一个参数，获取第一个元素的样式</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> computedStyle<span class="token punctuation">,</span> element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token comment">// 如果第一个元素无值，直接返回。否则继续</span>

        <span class="token comment">// 获取元素的计算后的样式</span>
        computedStyle <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> property <span class="token operator">==</span> <span class="token string">'string'</span><span class="token punctuation">)</span>
          <span class="token comment">// 情况1，参数为字符串形式</span>
          <span class="token comment">// 先从elem内联样式获取（element.style），此时需要 camelize(property) 转换，如将 background-color 变为 backgroundColor</span>
          <span class="token comment">// 如果未找到，则从css样式获取 computedStyle.getPropertyValue(property) </span>
          <span class="token comment">// （重要）注释：elem.style 只能获取元素设置的内联样式、不能获取css样式；而 getComputedStyle 可获取内联、css样式。</span>
          <span class="token keyword">return</span> element<span class="token punctuation">.</span>style<span class="token punctuation">[</span><span class="token function">camelize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> computedStyle<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 情况2，参数为数组形式（注意，此时 isObject 情况尚未判断）</span>
          <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>style<span class="token punctuation">[</span><span class="token function">camelize</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> computedStyle<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> props  <span class="token comment">// 返回一个对象</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 其他情况：有两个参数、property是对象</span>
      <span class="token keyword">var</span> css <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 情况1，property 是字符串，设置单个样式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果value参数是 '' null undefined 则移除这个css样式</span>
          <span class="token comment">// 注：此计算只适用于内联样式的删除，对 css 样式无效，因为它只通过 this.style.removeProperty 计算，而 this.style 获取不到css样式</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span><span class="token function">dasherize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
          <span class="token comment">// value有正常值，将 css 生成一个字符串（如 'font-size:20px'）等待赋值给内联样式</span>
          <span class="token comment">// maybeAddPx(property, value) 需要增加 px 的增加上</span>
          css <span class="token operator">=</span> <span class="token function">dasherize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token function">maybeAddPx</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 情况2，property 是对象（此时就不管第二个参数是什么了，不用第二个参数），一次性设置多个样式</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> property<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// 如果对象属性值是 '' null undefined 则移除这个css样式，同理，只针对内联样式</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span><span class="token function">dasherize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token comment">// 否则，给 css 赋值一个字符串，多样式属性用 ; 隔开</span>
            css <span class="token operator">+=</span> <span class="token function">dasherize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> <span class="token function">maybeAddPx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> property<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 针对每个元素，设置内联样式（this.style.cssText可获取、设置内联样式）</span>
      <span class="token comment">// 最后返回自身</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">+=</span> <span class="token string">';'</span> <span class="token operator">+</span> css <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">/*
        上文定义：
        // 将 lineHeight 转换为 line-height 格式
        function dasherize(str) {
          return str.replace(/::/g, '/')
                    .replace(/([A-Z]+)([A-Z][a-z])/g, '$1_$2')
                    .replace(/([a-z\d])([A-Z])/g, '$1_$2')
                    .replace(/_/g, '-')
                    .toLowerCase()
        }
      */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 获取一个元素的索引值（从0开始计数）。当elemen参数没有给出时，返回当前元素在兄弟节点中的位置</span>
    <span class="token function-variable function">index</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">/*
        上文定义：
        $.fn.indexOf: emptyArray.indexOf
      */</span>

      <span class="token comment">// 其实 this 本身就是一个数组，数组本身就有 indexOf ，为何还要上文的这个赋值呢？</span>
      <span class="token comment">// 因为上文中，this.__proto__ 修改了，不是 Array.prototype 了，也就没有 indexOf 方法了</span>
      <span class="token comment">// 因此要手动赋值，需要将数组常用的方法在重新赋值给 $.fn.indexOf</span>

      <span class="token keyword">return</span> element <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hasClass</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token keyword">return</span> emptyArray<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// this 就是 classRE(name) 的返回值（返回一个正则）</span>
        <span class="token comment">// function className(node, value){...} 获取或者设置elem的className</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token function">className</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">classRE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">// array.some(callback,[ thisObject]); 只要数组中一项符合callback要求，即返回true</span>

      <span class="token comment">/*
        // 上文定义 classCache = {}
        function classRE(name) {
          return name in classCache ?
                 classCache[name] : 
                 (classCache[name] = new RegExp('(^|\\s)' + name + '(\\s|$)'))

          // classCache 存储的数据是这样的：
          // {
          //   abc: /(^|\s)abc(\s|$)/,  // 能匹配 'abc' 或 ' abc ' 或 ' abc' 或 'abc '
          //   xyz: /(^|\s)abc(\s|$)/,
          //   ...
          // }
        }
      */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">addClass</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span>

      <span class="token comment">// 针对所有元素都添加className，最终返回本身</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 说明当前元素不是 DOM node</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'className'</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

        <span class="token comment">// classList 是一开始就定义的空变量</span>
        classList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">// 获取元素的 clasname      // 支持传入函数</span>
        <span class="token keyword">var</span> cls <span class="token operator">=</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newName <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
        <span class="token comment">// 把要赋值的值，按照空白分组，遍历</span>
        newName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s+/g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">klass</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 把当前元素不存在的class，push到classlist中</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">)</span> classList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 如果classlist有数据，则为当前元素赋值最新的class值（现有的classname和新的classname拼接）</span>
        classList<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cls <span class="token operator">+</span> <span class="token punctuation">(</span>cls <span class="token operator">?</span> <span class="token string">&quot; &quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> classList<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">removeClass</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 针对所有元素都移除className，最终返回本身</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 说明当前元素不是 DOM node</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'className'</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

        <span class="token comment">// 如果参数空，则移除元素的所有class</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

        <span class="token comment">// 获取现有的classname</span>
        classList <span class="token operator">=</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// （可以传入函数）遍历新的classname字符串</span>
        <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> classList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s+/g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">klass</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// classRE(klass) 返回一个正则，匹配 'classname' 或 ' classname ' 或 ' classname' 或 'classname '</span>
          <span class="token comment">// 针对传入的classname字符串，对每个符合条件的classname，都替换为 ' '（即删除了）</span>
          classList <span class="token operator">=</span> classList<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">classRE</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 对整理好的classname，重新赋值给当前元素</span>
        <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> classList<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">toggleClass</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> when</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// when 参数相当于一个条件：</span>
      <span class="token comment">// 如果 when === true 则单纯执行 addClass</span>
      <span class="token comment">// 如果 when === false 则单纯执行 removeClass</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//                   name 可接收函数，可以是空白分割开来的多个classname</span>
        <span class="token keyword">var</span> $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> names <span class="token operator">=</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token function">className</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 用空白分割开多个class</span>
        names<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s+/g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">klass</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 如果有 when 参数，则只通过when参数判断，true则只执行addClass，false则只执行removeClass</span>
          <span class="token comment">// 如果没有 when 参数，则判断元素有没有该class，有则移除，没有则添加</span>
          <span class="token punctuation">(</span>when <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token operator">!</span>$<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span> <span class="token punctuation">:</span> when<span class="token punctuation">)</span> <span class="token operator">?</span>
            $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span> <span class="token punctuation">:</span> $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">scrollTop</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span>

      <span class="token comment">// 普通elem有 scrollTop 属性，可以获取或者设置top值</span>
      <span class="token comment">// window对象没有 scrollTop 属性，通过 pageYOffset 获取，通过 scrollTo() 赋值</span>

      <span class="token keyword">var</span> hasScrollTop <span class="token operator">=</span> <span class="token string">'scrollTop'</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token comment">// value 无值，获取 top</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hasScrollTop <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>scrollTop <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageYOffset
      <span class="token comment">// value 有值，设置 top</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>hasScrollTop <span class="token operator">?</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> value <span class="token punctuation">}</span> <span class="token punctuation">:</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scrollX<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">// window.scrollX 获取横向滚动值</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">scrollLeft</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">var</span> hasScrollLeft <span class="token operator">=</span> <span class="token string">'scrollLeft'</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hasScrollLeft <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>scrollLeft <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageXOffset
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>hasScrollLeft <span class="token operator">?</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scrollLeft <span class="token operator">=</span> value <span class="token punctuation">}</span> <span class="token punctuation">:</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scrollY<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">// window.scrollX 获取纵向滚动值</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">position</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span>

      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// Get *real* offsetParent</span>
        offsetParent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">offsetParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 找到第一个定位过的祖先元素 “relative”, “absolute” or “fixed”</span>
        <span class="token comment">// Get correct offsets</span>
        offset       <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取自身的offset</span>
        parentOffset <span class="token operator">=</span> rootNodeRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodeName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span> top<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> left<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span> offsetParent<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 获取定位祖先元素的offset（ body、html直接设置 top:0;left:0 ）</span>
      <span class="token comment">// 上文定义： rootNodeRE = /^(?:body|html)$/i,</span>

      <span class="token comment">// 去掉当前元素的 margin 宽度</span>
      <span class="token comment">// Subtract element margins</span>
      <span class="token comment">// note: when an element has margin: auto the offsetLeft and marginLeft</span>
      <span class="token comment">// are the same in Safari causing offset.left to incorrectly be 0</span>
      offset<span class="token punctuation">.</span>top  <span class="token operator">-=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'margin-top'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>
      offset<span class="token punctuation">.</span>left <span class="token operator">-=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'margin-left'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>

      <span class="token comment">// 增加父元素的 border 宽度</span>
      <span class="token comment">// Add offsetParent borders</span>
      parentOffset<span class="token punctuation">.</span>top  <span class="token operator">+=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> <span class="token function">$</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'border-top-width'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>
      parentOffset<span class="token punctuation">.</span>left <span class="token operator">+=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> <span class="token function">$</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'border-left-width'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>

      <span class="token comment">// Subtract the two offsets</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        top<span class="token punctuation">:</span>  offset<span class="token punctuation">.</span>top  <span class="token operator">-</span> parentOffset<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
        left<span class="token punctuation">:</span> offset<span class="token punctuation">.</span>left <span class="token operator">-</span> parentOffset<span class="token punctuation">.</span>left
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">offsetParent</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 this.map 遍历当前对象所有元素，进行计算，然后拼接新的数组，并返回。保证链式操作</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetParent <span class="token operator">||</span> document<span class="token punctuation">.</span>body  <span class="token comment">// elem.offsetParent 可返回最近的改元素最近的已经定位的父元素</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rootNodeRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>nodeName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">$</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果获取的parent不是null、不是body或html、而且position==static</span>
          <span class="token comment">// 则继续向上查找 offsetParent、大不了找到 body 为止</span>
          parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>offsetParent

        <span class="token comment">// 最后返回改元素</span>
        <span class="token keyword">return</span> parent
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// for now</span>
  $<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>detach <span class="token operator">=</span> $<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>remove

  <span class="token comment">// Generate the `width` and `height` functions</span>
  <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dimension</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 将 width height 变为  Width Height</span>
    <span class="token keyword">var</span> dimensionProperty <span class="token operator">=</span>
      dimension<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/./</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    $<span class="token punctuation">.</span>fn<span class="token punctuation">[</span>dimension<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> offset<span class="token punctuation">,</span> el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

      <span class="token comment">// 情况1，无参数，获取第一个元素的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">isWindow</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el<span class="token punctuation">[</span><span class="token string">'inner'</span> <span class="token operator">+</span> dimensionProperty<span class="token punctuation">]</span> <span class="token punctuation">:</span>  <span class="token comment">// window.innerHeight</span>
        <span class="token function">isDocument</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el<span class="token punctuation">.</span>documentElement<span class="token punctuation">[</span><span class="token string">'scroll'</span> <span class="token operator">+</span> dimensionProperty<span class="token punctuation">]</span> <span class="token punctuation">:</span>  <span class="token comment">// document.documentElement.scrollHeight</span>
        <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> offset<span class="token punctuation">[</span>dimension<span class="token punctuation">]</span>  <span class="token comment">// this.offset().width</span>

      <span class="token comment">// 情况2，有参数，设置所有元素的值</span>
      <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        el <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 通过 css() 方法设置，支持传入函数</span>
        el<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>dimension<span class="token punctuation">,</span> <span class="token function">funcArg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> el<span class="token punctuation">[</span>dimension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 针对当前元素、遍历子元素，都执行 fun 函数</span>
  <span class="token keyword">function</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> fun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fun</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token function">traverseNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fun<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 上文定义 adjacencyOperators = [ 'after', 'prepend', 'before', 'append' ],</span>
  
  <span class="token comment">// Generate the `after`, `prepend`, `before`, `append`,</span>
  <span class="token comment">// `insertAfter`, `insertBefore`, `appendTo`, and `prependTo` methods.</span>
  adjacencyOperators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">operator<span class="token punctuation">,</span> operatorIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> inside <span class="token operator">=</span> operatorIndex <span class="token operator">%</span> <span class="token number">2</span> <span class="token comment">//=&gt; prepend, append</span>

    $<span class="token punctuation">.</span>fn<span class="token punctuation">[</span>operator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// arguments can be nodes, arrays of nodes, Zepto objects and HTML strings</span>
      <span class="token keyword">var</span> argType<span class="token punctuation">,</span> nodes <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            argType <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token keyword">return</span> argType <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> argType <span class="token operator">==</span> <span class="token string">&quot;array&quot;</span> <span class="token operator">||</span> arg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
              arg <span class="token punctuation">:</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          parent<span class="token punctuation">,</span> copyByClone <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        parent <span class="token operator">=</span> inside <span class="token operator">?</span> target <span class="token punctuation">:</span> target<span class="token punctuation">.</span>parentNode

        <span class="token comment">// convert all methods to a &quot;before&quot; operation</span>
        target <span class="token operator">=</span> operatorIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>nextSibling <span class="token punctuation">:</span>
                 operatorIndex <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>firstChild <span class="token punctuation">:</span>
                 operatorIndex <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> target <span class="token punctuation">:</span>
                 <span class="token keyword">null</span>

        <span class="token keyword">var</span> parentInDocument <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

        nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>copyByClone<span class="token punctuation">)</span> node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>parentInDocument<span class="token punctuation">)</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nodeName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'SCRIPT'</span> <span class="token operator">&amp;&amp;</span>
               <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>type <span class="token operator">||</span> el<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>src<span class="token punctuation">)</span>
              window<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> el<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// after    =&gt; insertAfter</span>
    <span class="token comment">// prepend  =&gt; prependTo</span>
    <span class="token comment">// before   =&gt; insertBefore</span>
    <span class="token comment">// append   =&gt; appendTo</span>
    $<span class="token punctuation">.</span>fn<span class="token punctuation">[</span>inside <span class="token operator">?</span> operator<span class="token operator">+</span><span class="token string">'To'</span> <span class="token punctuation">:</span> <span class="token string">'insert'</span><span class="token operator">+</span><span class="token punctuation">(</span>operatorIndex <span class="token operator">?</span> <span class="token string">'Before'</span> <span class="token punctuation">:</span> <span class="token string">'After'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span>operator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  zepto<span class="token punctuation">.</span><span class="token class-name">Z</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> $<span class="token punctuation">.</span>fn

  <span class="token comment">// Export internal API functions in the `$.zepto` namespace</span>
  zepto<span class="token punctuation">.</span>uniq <span class="token operator">=</span> uniq
  zepto<span class="token punctuation">.</span>deserializeValue <span class="token operator">=</span> deserializeValue
  $<span class="token punctuation">.</span>zepto <span class="token operator">=</span> zepto

  <span class="token keyword">return</span> $
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

window<span class="token punctuation">.</span>Zepto <span class="token operator">=</span> Zepto
window<span class="token punctuation">.</span>$ <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>$ <span class="token operator">=</span> Zepto<span class="token punctuation">)</span>
</code></pre></div><h2 id="vue"><a href="#vue" aria-hidden="true" class="header-anchor">#</a> Vue</h2> <h3 id="常见面试题"><a href="#常见面试题" aria-hidden="true" class="header-anchor">#</a> 常见面试题</h3> <ol><li>为什么v-for里要用key</li></ol> <ul><li>不要使用index和随机数</li> <li>因为diff算法会拿tag和key来对比是否为sameNode</li> <li>减少渲染次数, 提高渲染性能</li></ul> <h3 id="_1-vue响应式的实现"><a href="#_1-vue响应式的实现" aria-hidden="true" class="header-anchor">#</a> 1. Vue响应式的实现</h3> <ul><li>核心API Object.defineProperty的使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 准备数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  info<span class="token punctuation">:</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  arr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据, 使其变成响应式</span>
<span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> 

<span class="token keyword">const</span> oldArrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token keyword">const</span> arrProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayProto<span class="token punctuation">)</span>

<span class="token keyword">let</span> methodArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">]</span>
methodArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">methodName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    methodArr<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        oldArrayProto<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrProto
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 深度监听</span>
  <span class="token function">observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对新设置的值也进行监听</span>
        <span class="token function">observer</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>

        value <span class="token operator">=</span> newValue
        <span class="token comment">// 触发识图更新</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'视图更新'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

</code></pre></div><ul><li>Object.definProperty的缺点</li></ul> <ol><li>深度监听, 需要递归到底, 一次性计算量大</li> <li>无法监听新增删除属性(Vue set Vue delete)</li> <li>无法监听原生数组, 需要特殊处理</li></ol> <h3 id="_2-vue渲染更新过程"><a href="#_2-vue渲染更新过程" aria-hidden="true" class="header-anchor">#</a> 2. Vue渲染更新过程</h3> <ol><li>初次渲染过程</li></ol> <ul><li>解析模板为render函数, (开发环境一般使用vue-loader进行编译)</li> <li>触发响应式, 监听data的gettter, setter</li> <li>执行render函数, 生成vnode, 进行patch(elem, vnode)</li></ul> <ol start="2"><li>更新过程</li></ol> <ul><li>更新data数据, 触发setter</li> <li>重新执行render函数, 生成newVnode</li> <li>进行patch(vnode, newVnode)</li></ul> <h3 id="_2-虚拟dom"><a href="#_2-虚拟dom" aria-hidden="true" class="header-anchor">#</a> 2. 虚拟Dom</h3> <div class="language- extra-class"><pre class="language-text"><code>// 用js模拟dom结构
{
    tag: 'div',
    props: {
        className: 'container',
        id: 'div1'
    },
    children: [
        {
            tag: 'p',
            children: 'vdom'
        },
        {
            tag: 'ul',
            props: {
                style: 'font-size: 20px'
            },
            children: [
                {
                    tag: 'li',
                    children: 'a'
                }
            ]
        }
}
</code></pre></div><h2 id="react"><a href="#react" aria-hidden="true" class="header-anchor">#</a> React</h2> <h3 id="react渲染机制"><a href="#react渲染机制" aria-hidden="true" class="header-anchor">#</a> React渲染机制</h3> <div class="language- extra-class"><pre class="language-text"><code>当state和props发生变化的时候会触发render函数的重新执行
JSX =&gt; js对象 =&gt; 真实DOM

虚拟dom同层级比较, 所以key值尽量不要用index(不稳定)
</code></pre></div><h3 id="react生命周期"><a href="#react生命周期" aria-hidden="true" class="header-anchor">#</a> React生命周期</h3> <ol><li>Initialization</li></ol> <ul><li>setup state and props</li></ul> <ol start="2"><li>Mounting</li></ol> <ul><li>componentWillMount</li> <li>render</li> <li>componentDidMount</li></ul> <ol start="3"><li>Updation</li> <li>props:</li></ol> <ul><li>componenWilltPropsReceiveProps</li> <li>shouldComponentUpdate(通过返回布尔值选择是否继续执行)</li> <li>componentWillUpdate</li> <li>render</li> <li>componentDidUpdate</li></ul> <ol start="2"><li>states</li></ol> <ul><li>shouldComponentUpdate(通过返回布尔值选择是否继续执行)</li> <li>componentWillUpdate</li> <li>render</li> <li>componentDidUpdate</li></ul> <ol start="4"><li>Unmounting</li></ol> <ul><li>componentWillUnmount</li></ul> <h2 id="underscore"><a href="#underscore" aria-hidden="true" class="header-anchor">#</a> underscore</h2> <h3 id="基础框架"><a href="#基础框架" aria-hidden="true" class="header-anchor">#</a> 基础框架</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">_</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wrap <span class="token operator">=</span> data
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">unique</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> cb <span class="token operator">?</span> <span class="token function">cb</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> array
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">chain</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> instance
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">each</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">functions</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>wrap <span class="token operator">=</span> data
      <span class="token keyword">return</span> ctx
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data
  <span class="token punctuation">}</span>

  <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">value</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrap
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token keyword">var</span> func <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>wrap<span class="token punctuation">]</span>
        args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  _<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span>

  root<span class="token punctuation">.</span>_ <span class="token operator">=</span> _
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
</code></pre></div></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">8/25/2020, 2:15:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Blog/views/accumulate/JS-adv笔记.html" class="prev">
          JS-adv笔记
        </a></span> <span class="next"><a href="/Blog/views/accumulate/算法结构.html">
          算法结构
        </a>
        →
      </span></p></div> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/Blog/assets/js/app.a66dfa13.js" defer></script><script src="/Blog/assets/js/5.3af05e9e.js" defer></script><script src="/Blog/assets/js/1.b259d1a7.js" defer></script><script src="/Blog/assets/js/16.3442ad82.js" defer></script>
  </body>
</html>
